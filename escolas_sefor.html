<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEFOP - Busca e Edi√ß√£o de Escolas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilo para inputs no modo de edi√ß√£o */
        .editable-input {
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #1f2937;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <script src="escolas_data.js"></script>

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 mt-10">

        <h1 class="text-3xl font-bold text-gray-800 mb-2">üîç Busca e Gerenciamento de Escolas</h1>
        <p id="total-escolas" class="text-lg text-gray-500 mb-4 font-semibold">Carregando total...</p>

        <div class="mb-6 flex justify-end">
            <button id="export-json-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold 
            py-2 px-4 rounded-lg transition duration-300 shadow-md">
                Exportar Dados Atualizados (JSON)
            </button>
        </div>

        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 rounded-lg" role="alert">
            <p class="font-bold">Aten√ß√£o!</p>
            <p class="text-sm">As altera√ß√µes s√£o salvas apenas no seu navegador via **LocalStorage**.
            Use o bot√£o "Exportar Dados" para salvar permanentemente.</p>
        </div>

        <div class="mb-6">
            <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">Pesquisar por Nome da Escola (parte ou nome completo):</label>
            <input type="text" id="search-input" placeholder="Ex: liceu, adauto, filomeno..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base">
        </div>
        
        <div id="results-container" class="space-y-4">
            <p class="text-gray-500">Comece a digitar para buscar escolas.</p>
        </div>
        
    </div>

    <script>
        // Vari√°vel de trabalho renomeada para 'dataArray' para evitar o erro "escolasData' has already been declared"
        let dataArray = []; 
        const LOCAL_STORAGE_KEY = 'escolas_data_updated';

        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('results-container');
        const totalEscolasElement = document.getElementById('total-escolas');
        const exportJsonBtn = document.getElementById('export-json-btn');

        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            let escolasFonte; 

            if (storedData) {
                try {
                    escolasFonte = JSON.parse(storedData);
                } catch (e) {
                    // CR√çTICO: Refer√™ncia corrigida para a vari√°vel global 'escolasData'
                    escolasFonte = window.escolasData; 
                }
            } else if (typeof window.escolasData !== 'undefined') { 
                // CR√çTICO: Refer√™ncia corrigida para a vari√°vel global 'escolasData'
                escolasFonte = window.escolasData;
            } else {
                escolasFonte = [];
            }
            
            // Atribui a fonte de dados √† vari√°vel de trabalho
            dataArray = escolasFonte; 

            // Garante que cada escola tenha um √≠ndice √∫nico
            dataArray = dataArray.map((escola, index) => ({
                ...escola,
                data_id: escola.nome 
                    ? escola.nome.replace(/\s/g, '_') : index 
            }));
            
            if (dataArray.length > 0) {
                totalEscolasElement.textContent = `Total de Escolas Registradas: ${dataArray.length}`;
            } else {
                totalEscolasElement.textContent = "Erro: Dados das escolas n√£o encontrados ou vazios.";
                totalEscolasElement.classList.add('text-red-500');
            }
            
            // CR√çTICO: Chamada inicial para mostrar todas as escolas ao carregar a p√°gina
            if (dataArray.length > 0) {
                searchAndRender(); 
            }
        }

        function saveData() {
            try {
                // Usando 'dataArray'
                const dataToSave = dataArray.map(e => {
                    const { data_id, ...rest } = e;
                    return rest;
                });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                alert('Erro ao salvar os dados no navegador (localStorage).');
            }
        }

        /**
         * 3. Executa a pesquisa e renderiza os resultados
         * CORRIGIDO: Removido o filtro 'searchTerm.length < 3' para permitir busca em tempo real.
         */
        function searchAndRender() {
            // Pega o termo de busca, remove espa√ßos e transforma em MAI√öSCULAS
            const searchTerm = searchInput.value.trim().toUpperCase();

            // Usando 'dataArray'
            if (dataArray.length === 0) {
                return; 
            }
            
            // Se o campo de busca estiver vazio, mostre TODAS as escolas (para recarga inicial)
            if (searchTerm.length === 0) {
                renderSearchResults(dataArray); 
                return; 
            }

            // Filtra as escolas: verifica se o NOME inclui o termo pesquisado
            const filteredSchools = dataArray.filter(escola => {
                if (escola.nome) {
                    return escola.nome.toUpperCase().includes(searchTerm);
                }
                return false;
            });
            
            // Ordena e renderiza os resultados filtrados
            filteredSchools.sort((a, b) => a.nome.localeCompare(b.nome));
            renderSearchResults(filteredSchools);
        }


        function renderSearchResults(schools) {
            // Mensagem quando o filtro retorna 0 resultados
            if (schools.length === 0 && searchInput.value.trim().length > 0) {
                 resultsContainer.innerHTML = '<p class="text-red-500 font-semibold">Nenhuma escola encontrada com o termo pesquisado.</p>';
                return;
            } else if (schools.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500">Nenhum dado de escola dispon√≠vel para exibir.</p>';
                return;
            }

            let listHtml = '';
            const detailTextColor = 'text-blue-700';
            schools.forEach((escola, index) => {
                listHtml += generateSchoolListItem(escola, detailTextColor, index);
            });
            resultsContainer.innerHTML = `
                <p class="text-sm text-gray-600 mb-2 font-medium">Exibindo ${schools.length} escolas:</p>
                <div class="border border-gray-200 rounded-xl shadow-md overflow-hidden bg-white divide-y divide-gray-200">
                    ${listHtml}
                </div>
            `;
            addSchoolActionListeners();
        }

        function generateSchoolListItem(escola, detailTextColor, index) {
            const schoolIndex = index !== undefined ?
                index + 1 : '';

            // Mapeamento correto de campos
            const diretorContatoField = escola.contato_diretor ? 'Contato Diretor(a)' : 'Celular';
            const diretorContatoValue = escola.contato_diretor || escola.celular || 'N/A';

            return `
                <li id="school-${escola.data_id}" class="school-list-item p-4 transition duration-150 ease-in-out hover:bg-gray-50 data-id-${escola.data_id}" data-id="${escola.data_id}">
                    <div class="font-semibold text-gray-800 mb-2">
                        ${schoolIndex ? `${schoolIndex}. ` : ''} ${escola.nome}
                        <span class="text-xs font-medium text-gray-500 ml-2">(${escola.sefor || 'Regional N/A'})</span>
                    </div>

                    <div class="view-mode space-y-1 text-sm">
                        <div class="flex flex-wrap gap-x-4">
                            <span class="${detailTextColor} font-medium">E-mail:</span> 
                            <span data-field="email">${escola.email || 'N/A'}</span>
                        </div>
                        <div class="flex flex-wrap gap-x-4">
                            <span class="${detailTextColor} font-medium">Telefone:</span> 
                            <span data-field="telefone">${escola.telefone || 'N/A'}</span>
                        </div>
                        <div class="flex flex-wrap gap-x-4">
                            <span class="${detailTextColor} font-medium">Diretor(a):</span> 
                            <span data-field="diretor">${escola.diretor || 'N/A'}</span>
                        </div>
                        <div class="flex flex-wrap gap-x-4">
                            <span class="${detailTextColor} font-medium">${diretorContatoField}:</span>
                            <span data-field="contato_diretor">${diretorContatoValue}</span>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn-edit bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-300 shadow-sm" data-action="edit">
                                Atualizar Informa√ß√£o
                            </button>
                        </div>
                    </div>

                    <div class="edit-mode space-y-2 hidden p-3 border border-gray-200 rounded-lg bg-gray-100 mt-2">
                    </div>
                </li>
            `;
        }

        function addSchoolActionListeners() {
            // Usando 'dataArray'
            resultsContainer.querySelectorAll('.school-list-item').forEach(item => {
                const schoolId = item.getAttribute('data-id');
                const escola = dataArray.find(e => e.data_id === schoolId);
                const btnEdit = item.querySelector('.btn-edit');
                btnEdit.addEventListener('click', () => enterEditMode(item, escola));
            });
        }

        function enterEditMode(listItem, escola) {
            listItem.querySelector('.view-mode').classList.add('hidden');
            const editModeDiv = listItem.querySelector('.edit-mode');
            editModeDiv.classList.remove('hidden');

            // Mapeamento correto dos campos para edi√ß√£o
            const fields = ['email', 'telefone', 'diretor', 'contato_diretor']; 
            let editHtml = `<h3 class="font-bold text-gray-800 text-sm mb-2">Editar Contatos</h3>`;
            
            fields.forEach(field => {
                const labelMap = {
                    email: 'E-mail',
                    telefone: 'Telefone Escola',
                    diretor: 'Diretor(a)',
                    contato_diretor: 'Contato Diretor(a)' 
                };
                const label = labelMap[field];
                
                editHtml += `
                    <div class="flex items-center">
                        <label for="edit-${escola.data_id}-${field}" class="w-1/4 font-medium 
                        text-gray-700 text-xs">${label}:</label>
                        <input id="edit-${escola.data_id}-${field}" type="text" value="${escola[field] || ''}" data-field="${field}" class="editable-input w-3/4">
                    </div>
                `;
            });

            editHtml += `
                <div class="flex justify-end space-x-2 pt-2">
                    <button class="btn-save bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-300" data-id="${escola.data_id}">
                        Salvar Altera√ß√µes
                    </button>
                    <button class="btn-cancel bg-gray-400 hover:bg-gray-500 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-300" data-id="${escola.data_id}">
                        Cancelar
                    </button>
                </div>
            `;
            editModeDiv.innerHTML = editHtml;

            listItem.querySelector('.btn-save').addEventListener('click', () => saveChanges(listItem, escola));
            listItem.querySelector('.btn-cancel').addEventListener('click', () => exitEditMode(listItem, escola));
        }

        function exitEditMode(listItem, escola) {
            listItem.querySelector('.edit-mode').classList.add('hidden');
            listItem.querySelector('.view-mode').classList.remove('hidden');
        }

        function saveChanges(listItem, escola) {
            const inputs = listItem.querySelectorAll('.edit-mode input');
            let updated = false;

            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const newValue = input.value.trim();
                
                if (escola[field] !== newValue) {
                    escola[field] = newValue;
                    updated = true;
                }
            });
            if (updated) {
                saveData();
                searchAndRender(); 
                alert(`Informa√ß√£o da escola "${escola.nome}" atualizada e salva no seu navegador.`);
            } else {
                alert('Nenhuma altera√ß√£o detectada.');
                exitEditMode(listItem, escola);
            }
        }

        exportJsonBtn.addEventListener('click', () => {
            // Usando 'dataArray'
            const exportData = dataArray.map(e => {
                const { data_id, ...rest } = e;
                return rest;
            });
            const json = JSON.stringify(exportData, null, 4);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'escolas_data_atualizado.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Arquivo JSON com os dados atualizados gerado com sucesso!');
        });
        
        searchInput.addEventListener('input', searchAndRender);
        loadData();
    </script>
</body>
</html>
