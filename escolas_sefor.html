<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEFOP - Escolas por SEFOR (Com Edi√ß√£o)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .collapse-content.active {
            max-height: 5000px; 
            transition: max-height 0.6s ease-in;
        }
        /* Estilo para inputs no modo de edi√ß√£o */
        .editable-input {
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            color: #1f2937; /* text-gray-800 */
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <script src="escolas_data.js"></script>

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 mt-10">

        <h1 class="text-3xl font-bold text-gray-800 mb-2">üìä Escolas por Regional (SEFOR)</h1>
        <p id="total-escolas" class="text-lg text-gray-500 mb-4 font-semibold">Carregando total...</p>

        <div class="mb-6 flex justify-end">
            <button id="export-json-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">
                Exportar Dados Atualizados (JSON)
            </button>
        </div>

        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 rounded-lg" role="alert">
            <p class="font-bold">Aten√ß√£o!</p>
            <p class="text-sm">As altera√ß√µes s√£o salvas apenas no seu navegador via **LocalStorage** e n√£o no arquivo `escolas_data.js`. Use o bot√£o "Exportar Dados" para salvar as altera√ß√µes permanentemente.</p>
        </div>

        <div id="sefor-container" class="space-y-4">
            </div>
        
    </div>

    <script>
        // Vari√°vel global que armazenar√° o array de dados, carregado do localStorage ou do arquivo.
        let escolasData = [];
        const LOCAL_STORAGE_KEY = 'escolas_data_updated';

        const seforContainer = document.getElementById('sefor-container');
        const totalEscolasElement = document.getElementById('total-escolas');
        const exportJsonBtn = document.getElementById('export-json-btn');

        /**
         * 1. Carrega os dados, priorizando o localStorage
         */
        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                try {
                    escolasData = JSON.parse(storedData);
                    console.log('Dados carregados do localStorage.');
                } catch (e) {
                    // Se houver erro ao parsear, usa os dados do arquivo
                    escolasData = window.escolas_data; 
                    console.log('Erro ao parsear localStorage. Usando dados originais do arquivo.');
                }
            } else if (typeof window.escolas_data !== 'undefined') {
                // Carrega do arquivo JS se n√£o houver nada no localStorage
                escolasData = window.escolas_data;
                console.log('Dados originais carregados do arquivo escolas_data.js.');
            } else {
                // Caso extremo: nenhum dado encontrado
                console.error('Nenhum dado das escolas encontrado.');
                escolasData = [];
            }

            // Garante que cada escola tenha um √≠ndice √∫nico para facilitar a manipula√ß√£o
            escolasData = escolasData.map((escola, index) => ({
                ...escola,
                data_id: index
            }));
            
            // Atualiza o total de escolas e renderiza a interface
            if (escolasData.length > 0) {
                totalEscolasElement.textContent = `Total de Escolas Registradas: ${escolasData.length}`;
                renderSeforPanels();
            } else {
                totalEscolasElement.textContent = "Erro: Dados das escolas n√£o encontrados ou vazios.";
                totalEscolasElement.classList.add('text-red-500');
            }
        }

        /**
         * 2. Salva o array de dados no localStorage
         */
        function saveData() {
            try {
                // Remove o √≠ndice tempor√°rio 'data_id' antes de salvar, se desejar
                const dataToSave = escolasData.map(e => {
                    const { data_id, ...rest } = e;
                    return rest;
                });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('Dados salvos no localStorage.');
            } catch (e) {
                alert('Erro ao salvar os dados no navegador (localStorage).');
                console.error('Erro ao salvar no localStorage:', e);
            }
        }

        /**
         * 3. Renderiza a estrutura completa de pain√©is colaps√°veis
         */
        function renderSeforPanels(seforToOpen = 'SEFOR 1') {
            seforContainer.innerHTML = '';
            
            // Agrupa e ordena
            const groupedSchools = escolasData.reduce((acc, escola) => {
                const sefor = escola.sefor;
                if (!acc[sefor]) acc[sefor] = [];
                acc[sefor].push(escola);
                return acc;
            }, {});
            const sortedSeforKeys = Object.keys(groupedSchools).sort();

            sortedSeforKeys.forEach((seforKey, index) => {
                const escolasDoSefor = groupedSchools[seforKey];
                escolasDoSefor.sort((a, b) => a.nome.localeCompare(b.nome));

                const panel = document.createElement('div');
                panel.className = 'border border-gray-200 rounded-xl shadow-sm overflow-hidden';

                // Configura√ß√µes de cores
                let bgColor = 'bg-blue-500';
                let hoverColor = 'hover:bg-blue-600';
                let detailTextColor = 'text-blue-700';
                if (seforKey.includes('1')) {
                    bgColor = 'bg-green-600';
                    hoverColor = 'hover:bg-green-700';
                    detailTextColor = 'text-green-700';
                } else if (seforKey.includes('2')) {
                    bgColor = 'bg-yellow-600';
                    hoverColor = 'hover:bg-yellow-700';
                    detailTextColor = 'text-yellow-700';
                } else if (seforKey.includes('3')) {
                    bgColor = 'bg-red-600';
                    hoverColor = 'hover:bg-red-700';
                    detailTextColor = 'text-red-700';
                }

                // Cabe√ßalho (Bot√£o de toggle)
                const isFirstOrTarget = seforKey === seforToOpen || index === 0;
                const header = document.createElement('button');
                header.className = `flex justify-between items-center w-full p-4 text-left font-bold text-white ${bgColor} ${hoverColor} transition duration-300`;
                header.setAttribute('aria-expanded', isFirstOrTarget);
                header.innerHTML = `
                    <span class="text-xl">${seforKey}</span>
                    <span class="text-sm font-medium">(${escolasDoSefor.length} Escolas)</span>
                    <svg class="w-5 h-5 transition duration-300 transform ${isFirstOrTarget ? 'rotate-180' : ''}" data-arrow="${seforKey}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                panel.appendChild(header);

                // Conte√∫do Colaps√°vel
                const content = document.createElement('div');
                content.id = `content-${seforKey.replace(/\s/g, '-')}`;
                content.className = `collapse-content bg-gray-50 ${isFirstOrTarget ? 'active' : ''}`;

                // Lista de Escolas
                let listHtml = `<ul class="divide-y divide-gray-200">`;
                escolasDoSefor.forEach((escola) => {
                    listHtml += generateSchoolListItem(escola, detailTextColor);
                });
                listHtml += `</ul>`;
                
                content.innerHTML = listHtml;
                panel.appendChild(content);

                seforContainer.appendChild(panel);

                // Adiciona o evento de toggle ao cabe√ßalho
                header.addEventListener('click', createToggleHandler(header, content, seforKey));
            });

            // Adiciona event listeners para os bot√µes de A√ß√£o
            addSchoolActionListeners();
        }

        /**
         * 4. Gera o HTML de um item da lista de escolas
         */
        function generateSchoolListItem(escola, detailTextColor) {
            return `
                <li id="school-${escola.data_id}" class="school-list-item p-4 transition duration-150 ease-in-out hover:bg-white data-id-${escola.data_id}" data-id="${escola.data_id}">
                    <div class="font-semibold text-gray-800 mb-2" data-field="nome">${escola.nome}</div>

                    <div class="view-mode space-y-1">
                        <div class="text-sm text-gray-500">
                            <span class="${detailTextColor} font-medium mr-1">E-mail:</span> 
                            <span data-field="email">${escola.email || 'N/A'}</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span class="${detailTextColor} font-medium mr-1">Telefone:</span> 
                            <span data-field="telefone">${escola.telefone || 'N/A'}</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span class="${detailTextColor} font-medium mr-1">Diretor(a):</span> 
                            <span data-field="diretor">${escola.diretor || 'N/A'}</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span class="${detailTextColor} font-medium mr-1">Celular:</span> 
                            <span data-field="celular">${escola.celular || 'N/A'}</span>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn-edit bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-300 shadow-sm" data-action="edit">
                                Atualizar Informa√ß√£o
                            </button>
                        </div>
                    </div>

                    <div class="edit-mode space-y-2 hidden p-3 border border-gray-200 rounded-lg bg-white mt-2">
                        </div>
                </li>
            `;
        }

        /**
         * 5. Manipulador de eventos para o bot√£o de toggle (Sanfona)
         */
        function createToggleHandler(header, content, seforKey) {
            return () => {
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                
                // Toggle do conte√∫do
                content.classList.toggle('active', !isExpanded);
                header.setAttribute('aria-expanded', !isExpanded);
                
                // Rota√ß√£o do √≠cone de seta
                const arrow = header.querySelector('svg');
                arrow.classList.toggle('rotate-180', !isExpanded);

                // Fecha outros pain√©is (comportamento de sanfona)
                document.querySelectorAll('.collapse-content').forEach(otherContent => {
                    if (otherContent !== content && otherContent.classList.contains('active')) {
                        otherContent.classList.remove('active');
                        const otherHeader = otherContent.previousElementSibling;
                        otherHeader.setAttribute('aria-expanded', 'false');
                        otherHeader.querySelector('svg').classList.remove('rotate-180');
                    }
                });
            };
        }
        
        /**
         * 6. Adiciona listeners para os bot√µes de a√ß√£o (Editar/Salvar/Cancelar)
         */
        function addSchoolActionListeners() {
            document.querySelectorAll('.school-list-item').forEach(item => {
                const schoolId = parseInt(item.getAttribute('data-id'));
                const escola = escolasData.find(e => e.data_id === schoolId);
                
                const btnEdit = item.querySelector('.btn-edit');
                btnEdit.addEventListener('click', () => enterEditMode(item, escola));
            });
        }

        /**
         * 7. Entra no modo de edi√ß√£o (exibe inputs)
         */
        function enterEditMode(listItem, escola) {
            listItem.querySelector('.view-mode').classList.add('hidden');
            const editModeDiv = listItem.querySelector('.edit-mode');
            editModeDiv.classList.remove('hidden');

            // Campos para edi√ß√£o
            const fields = ['email', 'telefone', 'diretor', 'celular'];
            let editHtml = '';
            
            fields.forEach(field => {
                const label = field.charAt(0).toUpperCase() + field.slice(1);
                editHtml += `
                    <div class="flex items-center">
                        <label for="edit-${escola.data_id}-${field}" class="w-1/4 font-medium text-gray-700 text-xs">${label}:</label>
                        <input id="edit-${escola.data_id}-${field}" type="text" value="${escola[field] || ''}" data-field="${field}" class="editable-input w-3/4">
                    </div>
                `;
            });

            // Bot√µes de A√ß√£o
            editHtml += `
                <div class="flex justify-end space-x-2 pt-2">
                    <button class="btn-save bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-300" data-id="${escola.data_id}">
                        Salvar Altera√ß√µes
                    </button>
                    <button class="btn-cancel bg-gray-400 hover:bg-gray-500 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-300" data-id="${escola.data_id}">
                        Cancelar
                    </button>
                </div>
            `;
            
            editModeDiv.innerHTML = editHtml;

            // Adiciona listeners para os novos bot√µes no modo de edi√ß√£o
            listItem.querySelector('.btn-save').addEventListener('click', () => saveChanges(listItem, escola));
            listItem.querySelector('.btn-cancel').addEventListener('click', () => exitEditMode(listItem, escola));
        }

        /**
         * 8. Sai do modo de edi√ß√£o (retorna √† visualiza√ß√£o)
         */
        function exitEditMode(listItem, escola) {
            listItem.querySelector('.edit-mode').classList.add('hidden');
            listItem.querySelector('.view-mode').classList.remove('hidden');
        }

        /**
         * 9. Salva as altera√ß√µes
         */
        function saveChanges(listItem, escola) {
            const inputs = listItem.querySelectorAll('.edit-mode input');
            let updated = false;

            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const newValue = input.value.trim();
                
                if (escola[field] !== newValue) {
                    escola[field] = newValue;
                    updated = true;
                }
            });

            if (updated) {
                // 1. Atualiza o localStorage (persiste a altera√ß√£o no navegador)
                saveData(); 

                // 2. Re-renderiza o item da lista (para mostrar os novos valores)
                const parentUl = listItem.closest('ul');
                const newListItemHtml = generateSchoolListItem(escola, listItem.querySelector('[class*="-700"]').className.split(' ').find(c => c.includes('text-')));
                listItem.outerHTML = newListItemHtml; // Substitui o HTML completo

                // 3. Re-adiciona os listeners para o novo item
                const newItem = parentUl.querySelector(`.data-id-${escola.data_id}`);
                const btnEdit = newItem.querySelector('.btn-edit');
                btnEdit.addEventListener('click', () => enterEditMode(newItem, escola));

                alert(`Informa√ß√£o da escola "${escola.nome}" atualizada e salva no seu navegador.`);
            } else {
                alert('Nenhuma altera√ß√£o detectada.');
                exitEditMode(listItem, escola);
            }
        }

        /**
         * 10. Fun√ß√£o para exportar os dados atualizados como um arquivo JSON
         */
        exportJsonBtn.addEventListener('click', () => {
            // Remove o √≠ndice 'data_id' para exporta√ß√£o
            const exportData = escolasData.map(e => {
                const { data_id, ...rest } = e;
                return rest;
            });
            const json = JSON.stringify(exportData, null, 4); // Formata para leitura
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'escolas_data_atualizado.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Arquivo JSON com os dados atualizados gerado com sucesso!');
        });

        // Inicializa o carregamento dos dados
        loadData();
    </script>
</body>
</html>