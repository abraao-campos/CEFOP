<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEFOP - Extrator de E-mails de Escolas</title>
    <!-- Carregando Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Define a fonte Inter e um fundo suave */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilo para animação de notificação customizada (Toast) */
        .toast-enter {
            animation: slideIn 0.3s forwards;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <!-- Container Principal -->
    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-8 sm:p-12 mt-4">

        <!-- Cabeçalho -->
        <header class="text-center mb-10 p-4 rounded-lg bg-blue-100 shadow-md border-b-4 border-blue-500">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 leading-none">
                <i class="fas fa-envelope-open-text mr-2"></i> Extrator de E-mails
            </h1>
            <p class="text-base sm:text-lg font-semibold text-blue-700 mt-1">
                Busque as escolas e extraia os e-mails desejados.
            </p>
        </header>

        <!-- Seção de Pesquisa -->
        <section class="mb-8">
            <label for="searchInput" class="block text-lg font-semibold text-gray-700 mb-2">
                Pesquisar Escola(s)
            </label>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Digite nomes separados por vírgula (ex: 'adelino, patativa, gent')" 
                    class="w-full p-4 pl-12 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 outline-none"
                    oninput="filterSchools()"
                >
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <p id="matchCount" class="text-sm text-gray-500 mt-2">0 escolas encontradas.</p>
        </section>

        <!-- Botão de Copiar E-mails -->
        <div class="mb-8 flex justify-end">
            <button 
                id="copyEmailsButton"
                onclick="copyAllEmails()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                disabled
            >
                <i class="fas fa-copy mr-2"></i> Copiar Todos E-mails (<span id="emailCount">0</span>)
            </button>
        </div>

        <!-- Lista de Resultados -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Resultados da Pesquisa</h2>
            
            <ul id="results-list" class="divide-y divide-gray-200">
                <li class="p-3 text-center text-gray-500 italic">
                    Digite no campo de busca para começar a filtrar.
                </li>
            </ul>
        </section>

        <!-- Notificação Customizada (Toast) -->
        <div id="custom-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white py-3 px-6 rounded-lg shadow-xl hidden toast-enter z-[100]">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="toast-message"></span>
        </div>

    </div>

    <!-- Script de Funcionalidade (type="module" para usar o import) -->
    <script type="module">
        // Importa a lista de escolas do arquivo externo escolas_data.js
        // Este caminho ('./escolas_data.js') pressupõe que o arquivo de dados está no mesmo diretório.
        import { SCHOOLS } from './escolas_data.js';

        let filteredSchools = [];

        /**
         * Filtra a lista de escolas em tempo real com base no texto digitado.
         * Suporta múltiplos termos separados por vírgula.
         * É anexada ao window para ser acessível via oninput no HTML.
         */
        window.filterSchools = function() {
            const input = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsList = document.getElementById('results-list');
            const matchCount = document.getElementById('matchCount');
            const copyButton = document.getElementById('copyEmailsButton');
            const emailCount = document.getElementById('emailCount');

            // Divide a string de busca em termos individuais e limpa.
            const searchTerms = input
                .split(',') 
                .map(term => term.trim())
                .filter(term => term.length > 1);

            // Condição para mostrar o estado inicial (sem resultados)
            if (searchTerms.length === 0 && input.length < 2) {
                filteredSchools = [];
                resultsList.innerHTML = '<li class="p-3 text-center text-gray-500 italic">Digite no campo de busca para começar a filtrar.</li>';
                matchCount.textContent = '0 escolas encontradas.';
                copyButton.disabled = true;
                emailCount.textContent = '0';
                return;
            }

            // 1. Coleta escolas que correspondem a QUALQUER um dos termos
            const uniqueFilteredSchools = new Set();
            
            SCHOOLS.forEach(school => {
                const schoolName = school.nome.toLowerCase();
                
                // Verifica se o nome da escola inclui pelo menos um dos termos de busca
                const isMatch = searchTerms.some(term => schoolName.includes(term));
                
                if (isMatch) {
                    uniqueFilteredSchools.add(school);
                }
            });

            filteredSchools = Array.from(uniqueFilteredSchools);
            
            // 2. Ordena os resultados pelo nome da escola
            filteredSchools.sort((a, b) => a.nome.localeCompare(b.nome));

            // 3. Atualiza a interface
            renderResults(filteredSchools);

            // 4. Atualiza o contador e o botão de copiar
            matchCount.textContent = `${filteredSchools.length} escolas encontradas.`;
            emailCount.textContent = filteredSchools.length;
            copyButton.disabled = filteredSchools.length === 0;
        }

        /**
         * Renderiza a lista de resultados no DOM.
         * @param {Array<Object>} schools - A lista de escolas filtradas.
         */
        function renderResults(schools) {
            const resultsList = document.getElementById('results-list');
            
            if (schools.length === 0) {
                resultsList.innerHTML = `
                    <li class="p-3 text-center text-red-500 font-semibold">
                        <i class="fas fa-exclamation-triangle mr-1"></i> Nenhuma escola corresponde aos termos de busca.
                    </li>
                `;
                return;
            }

            // Mapeia a lista de escolas para elementos <li>
            const listItems = schools.map(school => `
                <li class="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-white transition duration-100">
                    <div>
                        <p class="font-semibold text-gray-800">${school.nome}</p>
                        <p class="text-sm text-blue-600 font-medium break-all" id="email-${school.email.replace(/@/g, '-at-')}">${school.email}</p>
                    </div>
                    <button 
                        onclick="copySingleEmail('${school.email}', event)"
                        class="mt-2 sm:mt-0 text-xs text-blue-500 hover:text-blue-700 font-medium flex items-center p-2 rounded-lg hover:bg-blue-50 transition"
                    >
                        <i class="fas fa-clipboard mr-1"></i> Copiar
                    </button>
                </li>
            `).join('');

            resultsList.innerHTML = listItems;
        }

        /**
         * Copia um único e-mail para a área de transferência.
         * É anexada ao window para ser acessível via onclick no HTML.
         */
        window.copySingleEmail = function(email, event) {
            const button = event.currentTarget;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-check mr-1"></i> Copiado!';

            copyToClipboard(email);
            showToast(`E-mail de ${email.split('@')[0]} copiado!`);

            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-clipboard mr-1"></i> Copiar';
            }, 2000);
        }

        /**
         * Copia todos os e-mails filtrados para a área de transferência.
         * É anexada ao window para ser acessível via onclick no HTML.
         */
        window.copyAllEmails = function() {
            if (filteredSchools.length === 0) return;

            const emails = filteredSchools.map(school => school.email).join(', ');
            
            copyToClipboard(emails);
            showToast(`Todos os ${filteredSchools.length} e-mails copiados com sucesso!`);
        }

        /**
         * Função utilitária para copiar texto para a área de transferência.
         * @param {string} text - O texto a ser copiado.
         */
        function copyToClipboard(text) {
             // Método execCommand é mais compatível em ambientes restritos (como iframes/Canvas)
             const tempInput = document.createElement('textarea');
             tempInput.value = text;
             document.body.appendChild(tempInput);
             tempInput.select();
             try {
                 document.execCommand('copy');
             } catch (err) {
                 console.error('Falha ao copiar:', err);
             }
             document.body.removeChild(tempInput);
        }

        /**
         * Exibe uma notificação customizada (Toast).
         * @param {string} message - A mensagem a ser exibida.
         */
        function showToast(message) {
            const toast = document.getElementById('custom-toast');
            const toastMessage = document.getElementById('toast-message');

            // 1. Oculta e reseta o estado
            toast.classList.add('hidden');
            toast.classList.remove('toast-enter'); 
            
            // 2. Define a mensagem
            toastMessage.textContent = message;

            // 3. Exibe com animação
            setTimeout(() => {
                toast.classList.remove('hidden');
                toast.classList.add('toast-enter'); 
            }, 10);

            // 4. Oculta após 3 segundos
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('hidden');
            }, 3000);
        }

        // Inicializa a página
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').focus(); // Foca no campo de busca
        });
    </script>
</body>
</html>
